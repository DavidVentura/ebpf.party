---
layout: ../../../layouts/ExerciseLayout.astro
title: Reading from specific files
codeFile: 2_read_file_password.c
exerciseId: read-file-password
---

In the previous exercise, we captured ALL read() calls. But what if we only care about reads from a specific file?

When a program reads from a file:
1. `openat()` opens the file → returns file descriptor (fd)
2. `read(fd, ...)` reads using that fd

Problem: By the time `read()` is called, we only see the fd number (like `4`), not the filename!

**Solution:** Use maps to correlate `openat` and `read` syscalls.

## Multiple syscall correlation

We'll track the relationship between file descriptors and filenames:

```
openat("/etc/config.toml") → returns fd=4
read(fd=4, buf, count)     → "Ah! Reading from config.toml"
```

## The openat syscall

```c
int openat(int dirfd, const char *pathname, int flags, mode_t mode);
```

We need:
- **Entry:** `ctx->args[1]` - the pathname
- **Exit:** `ctx->ret` - the file descriptor returned

## The strategy

We'll use **three maps**:

1. **Temporary pathname storage** (PID → pathname)
   - Store pathname from openat entry until exit

2. **FD to filename mapping** (fd → filename)
   - The permanent fd→filename correlation

3. **Read buffer tracking** (PID → buffer pointer)
   - Store read buffer pointer (like before)

## Map with string values

To store strings in maps, use a char array:

```c
struct {
    __uint(type, BPF_MAP_TYPE_HASH);
    __uint(max_entries, 1024);
    __type(key, u64);
    __type(value, char[64]);  // String storage
} string_map SEC(".maps");

// Storing
char filename[64];
bpf_probe_read_user_str(filename, sizeof(filename), pathname_ptr);
bpf_map_update_elem(&string_map, &key, filename, BPF_ANY);

// Retrieving
char *stored = bpf_map_lookup_elem(&string_map, &key);
if (!stored) return 0;
// stored is a pointer to the char[64] array
```

## The flow

```
1. openat ENTRY:  Store PID → pathname (temp map)
2. openat EXIT:   Get fd, lookup pathname, store fd → filename (main map)
3. read ENTRY:    Get fd, lookup filename, if "config.toml" → store buffer
4. read EXIT:     Lookup buffer, read contents, submit
```

## The challenge

A program opens and reads multiple files. Only `config.toml` contains the password.

Your task:

1. Define three maps
2. Track openat entry/exit to build fd→filename mapping
3. In read entry: Check if fd maps to "config.toml", store buffer if yes
4. In read exit: Read buffer and submit password

**Hints:**
- Use `bpf_strncmp(filename, 64, "config.toml") == 0` to check filenames
- Remember to check all map lookups for NULL
- Clean up map entries when done
- The file contains: `password = "secret_here"`

**Note on FD keys:** For simplicity, just use `fd` as the key (assumes single process scenario).
