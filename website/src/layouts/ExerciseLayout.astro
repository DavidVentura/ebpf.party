---
import InteractiveEditor from "../components/InteractiveEditor.astro";
import { readFile } from "node:fs/promises";
import { join } from "node:path";

const { frontmatter } = Astro.props;

let starterCode = frontmatter.starterCode || "";
const exerciseId = frontmatter.exerciseId!!;

const urlPath = Astro.url.pathname;
const chapterMatch = urlPath.match(/\/exercises\/(chapter-\d+)\//)!!;

const chapterSlug = chapterMatch[1];
const metadataPath = join(
  process.cwd(),
  "src/pages/exercises",
  chapterSlug,
  "metadata.json"
);
const metadata = JSON.parse(await readFile(metadataPath, "utf-8"));
let chapterId: number = metadata.number;
let chapterTitle = metadata.title;

const codeFilePath = join(
  process.cwd(),
  "public/exercises-code",
  chapterId.toString(),
  frontmatter.codeFile
);
starterCode = await readFile(codeFilePath, "utf-8");
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{chapterTitle} - {frontmatter.title}</title>
  </head>
  <body>
    <div class="container">
      <!-- Tab controls (hidden on desktop) -->
      <input
        type="radio"
        name="mobile-tabs"
        id="tab-instructions"
        class="tab-input"
        checked
      />
      <input type="radio" name="mobile-tabs" id="tab-code" class="tab-input" />

      <!-- Tab bar (mobile only) -->
      <div class="tab-bar">
        <label for="tab-instructions" class="tab-label">
          ðŸ“– Instructions
        </label>
        <label for="tab-code" class="tab-label"> ðŸ’» Code </label>
      </div>

      <!-- Content panes -->
      <div class="content tab-content">
        <div class="topbar">
          <a href="/" class="home-button">Home</a>
        </div>
        <div class="content-scroll">
          <h4>{chapterTitle}</h4>
          <h1>{frontmatter.title}</h1>
          <slot />
        </div>
      </div>

      <div class="editor-wrapper tab-content">
        <InteractiveEditor
          starterCode={starterCode}
          exerciseId={exerciseId}
          chapterId={chapterId}
        />
      </div>
    </div>
  </body>
</html>

<style>
  html,
  body {
    margin: 0;
    width: 100%;
    height: 100%;
    font-family: sans-serif;
  }

  h4 ~ h1,
  h4:has(~ h1) {
    padding: 0px;
    margin: 0.2em 0px 0px 0px;
    line-height: 1em;
  }
  h1 {
    font-size: 30px;
  }

  .container {
    display: flex;
    height: 100vh;
  }

  .content {
    flex: 1;
    overflow-y: auto;
  }

  .topbar {
    background: #f5f5f5;
    padding: 1rem;
    border-bottom: 1px solid #ddd;
  }

  .home-button {
    text-decoration: none;
    color: #555;
    font-weight: 500;
    font-size: 14px;
    display: inline-block;
    transition: color 0.2s;
  }

  .home-button:hover {
    color: #000;
  }

  .content-scroll {
    padding: 0.5rem 2rem 2rem 2rem;
  }

  /* Tab system - hidden on desktop */
  .tab-input {
    display: none;
  }

  .tab-bar {
    display: none;
  }

  .editor-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  /* Mobile-only tab system */
  @media (max-width: 1280px) {
    .container {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Show tab bar */
    .tab-bar {
      display: flex;
      background: #f5f5f5;
      border-bottom: 2px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .tab-label {
      flex: 1;
      text-align: center;
      padding: 1rem;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      user-select: none;
    }

    .tab-label:hover {
      background: #fafafa;
      color: #333;
    }

    /* Active tab styling */
    #tab-instructions:checked ~ .tab-bar label[for="tab-instructions"],
    #tab-code:checked ~ .tab-bar label[for="tab-code"] {
      color: #4caf50;
      border-bottom-color: #4caf50;
      background: white;
    }

    /* Hide all tab content by default */
    .tab-content {
      display: none;
    }

    /* Show active tab content */
    #tab-instructions:checked ~ .content.tab-content {
      display: block;
      flex: 1;
      overflow-y: auto;
    }

    #tab-code:checked ~ .editor-wrapper.tab-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .content {
      flex: none;
      overflow-y: visible;
    }

    .content-scroll {
      overflow-y: visible;
    }
  }
  /* mdx rules */
  .content-scroll :global(h2) {
    margin: 0.5em 0px;
  }
  .content-scroll :global(p),
  .content-scroll :global(pre:has(code)) {
    margin: 8px 0px;
  }
  .content-scroll :global(pre) {
    padding: 10px;
    border-radius: 4px;
    overflow-x: auto;
  }
  .content-scroll :global(:not(pre) > code) {
    background-color: rgb(220 220 220);
    border-radius: 4px;
    padding: 4px;
  }

  .content-scroll :global(details[open]::details-content) {
    padding: 0.5rem;
    border: 1px dotted black;
  }

  .content-scroll :global(p ~ ol, p ~ ul) {
    margin: 8px 0px;
  }
  .content-scroll :global(ul) {
    padding-left: 20px;
  }
</style>
